#' Export Line Listing of Cases
#'
#' @param sormas_db Connection to SORMAS database
#' 
#' @param fromDateSQL Start date of export for SQL export.
#' @param toDateSQL End date of export for SQL export.
#'
#' @return  Returns a table containing a line listing of all cases
#'  that fulfill one of the following conditions:
#'  - the report date is in the defined time period
#'  - the hospitalization date is in the defined time period
#'  - the death date is in the defined period
#'  This line listing of cases includes
#'  all the variables as columns that are necessary for the creation of the
#'  SitRep, apart from population and geo shapes data which can be exported 
#'  using the ExportPopulation() & ExportGeoshapes() functions.
#' 
#' @seealso [ExportPopulation()] and [ExportGeoshapes()]
#' 
#' @export
#'
#' @examples
#' 
ExportCaseLineList <- function(sormas_db, fromDateSQL, toDateSQL){
  
  ## Computing default time based on 365 days in the past if not provided by user
  if(missing(fromDateSQL) | missing(toDateSQL)){
    fromDateSQL = as.character(Sys.Date() - delay) 
    toDateSQL = as.character(Sys.Date()) 
  }
  
  ## Loading tables from SORMAS DB
  
  # Person table SQL query
  queryPersons <- base::sprintf("SELECT DISTINCT id AS id_person,
    deathDate AS death_date_person,
    causeOfDeath AS cause_of_death_person
    FROM public.person
    WHERE deathDate between '%s' and '%s'", fromDateSQL, toDateSQL)
  
  persons <- DBI::dbGetQuery(sormas_db,queryPersons)
  
  # Symptoms table SQL query
  querySymptoms <- base::sprintf("SELECT DISTINCT id AS id_symptoms,
    onsetDate AS onset_date_symptoms
    FROM public.symptoms 
    WHERE onsetDate between '%s' and '%s'", fromDateSQL, toDateSQL)
  
  symptoms <- DBI::dbGetQuery(sormas_db, querySymptoms)
  
  # Hospitalizations table query 
  queryHospitalizations <- base::sprintf("SELECT DISTINCT id AS id_hospitalization,
    admittedToHealthFacility AS admitted_to_health_facility_hospitalization,
    admissionDate AS admission_date_hospitalization,
    hospitalizationReason AS reason_hospitalization
    FROM public.hospitalization 
    WHERE admissionDate between '%s' and '%s'", fromDateSQL, toDateSQL)
  
  hospitalizations <- DBI::dbGetQuery(sormas_db, queryHospitalizations)
  
  # Case table SQL query based on report date
  queryCases_report_date <- base::sprintf("SELECT  DISTINCT id AS id_case,
    responsibledistrict_id AS id_district,
    responsibleregion_id AS id_region,
    caseclassification AS caseclassification_case,
    EndOfIsolationReason AS end_of_iso_reason_case,
    reportdate AS report_date_case,
    disease AS disease_case,
    symptoms_id AS id_symptoms,
    person_id AS id_person,
    hospitalization_id AS id_hospitalization
    FROM public.cases 
    WHERE (deleted = FALSE AND caseclassification != 'NO_CASE')
    AND (reportdate between '%s' and '%s')",
                              fromDateSQL, toDateSQL)

  cases_report_date <- DBI::dbGetQuery(sormas_db,queryCases_report_date)
  

  if (length(persons$id_person) > 0){  
  
  # Case table SQL query based on person id
  queryCases_person_id <- base::sprintf("SELECT  DISTINCT id AS id_case,
    responsibledistrict_id AS id_district,
    responsibleregion_id AS id_region,
    caseclassification AS caseclassification_case,
    EndOfIsolationReason AS end_of_iso_reason_case,
    reportdate AS report_date_case,
    disease AS disease_case,
    symptoms_id AS id_symptoms,
    person_id AS id_person,
    hospitalization_id AS id_hospitalization
    FROM public.cases 
    WHERE (deleted = FALSE AND caseclassification != 'NO_CASE')
    AND (person_id IN (%s))",
    paste("'", base::unique(c(persons$id_person)), "'",collapse=","))
  
  cases_person_id <- DBI::dbGetQuery(sormas_db,queryCases_person_id)
  }  else {
    cases_person_id <- data.frame()
  }

  
  if ( length(hospitalizations$id_hospitalization) > 0) {
  
  # Case table SQL query based on hospitalization id
  queryCases_hospitalization_id <- base::sprintf("SELECT  DISTINCT id AS id_case,
    responsibledistrict_id AS id_district,
    responsibleregion_id AS id_region,
    caseclassification AS caseclassification_case,
    EndOfIsolationReason AS end_of_iso_reason_case,
    reportdate AS report_date_case,
    disease AS disease_case,
    symptoms_id AS id_symptoms,
    person_id AS id_person,
    hospitalization_id AS id_hospitalization
    FROM public.cases 
    WHERE (deleted = FALSE AND caseclassification != 'NO_CASE')
    AND (hospitalization_id IN (%s))",
    paste("'", base::unique(c(hospitalizations$id_hospitalization)), "'",collapse=","))
  
  cases_hospitalization_id <- DBI::dbGetQuery(sormas_db,queryCases_hospitalization_id)
  } else {
    cases_hospitalization_id <- data.frame()
  }
  
  if ( length(symptoms$id_symptoms) > 0) {
  # Case table SQL query based on symptoms id
  queryCases_symptoms_id <- base::sprintf("SELECT  DISTINCT id AS id_case,
    responsibledistrict_id AS id_district,
    responsibleregion_id AS id_region,
    caseclassification AS caseclassification_case,
    EndOfIsolationReason AS end_of_iso_reason_case,
    reportdate AS report_date_case,
    disease AS disease_case,
    symptoms_id AS id_symptoms,
    person_id AS id_person,
    hospitalization_id AS id_hospitalization
    FROM public.cases 
    WHERE (deleted = FALSE AND caseclassification != 'NO_CASE')
    AND (symptoms_id IN (%s))",
                                                 paste("'", base::unique(c(symptoms$id_symptoms)), "'",collapse=","))
  
  cases_symptoms_id <- DBI::dbGetQuery(sormas_db,queryCases_symptoms_id)
  } else {
    cases_symptoms_id <- data.frame()
  }
  
  # bind rows of all the results of all case queries into one df
  cases <- dplyr::bind_rows(cases_report_date,
                            cases_person_id,
                            cases_hospitalization_id,
                            cases_symptoms_id)
  
  # Separate query for birthdate and sex
  queryBirthdateSex <- base::sprintf("SELECT DISTINCT id AS id_person,
    birthdate_dd as birthdate_dd_person,
    birthdate_mm as birthdate_mm_person,
    birthdate_yyyy as birthdate_yyyy_person,
    sex AS sex_person
    FROM public.person
    WHERE id IN (%s)", paste("'", base::unique(c(cases$id_person)), "'",collapse=","))
  
  birthdate_sex <- DBI::dbGetQuery(sormas_db, queryBirthdateSex)
  
  
  # District table SQL query
  queryDistrict <- paste0("SELECT DISTINCT id AS id_district,
    name AS name_district
    FROM public.district
    WHERE archived = FALSE
                          ")
  districts <- DBI::dbGetQuery(sormas_db, queryDistrict)
  
  # Region table SQL query
  queryRegions <- paste0("SELECT DISTINCT id AS id_region,
    name AS name_region
    FROM public.region 
    WHERE archived = FALSE
                         ")
  regions <- DBI::dbGetQuery(sormas_db, queryRegions)
  
  
  # Merging data from cases, persons, hospitalizations, birhtdate_sex,
  # districts and regions exports into one line listed data frame
  # with every row being a case 
  line_list_cases <- cases %>% 
    dplyr::left_join(., persons, by = 'id_person') %>% 
    dplyr::left_join(., birthdate_sex, by = 'id_person') %>% 
    dplyr::left_join(., symptoms, by = 'id_symptoms') %>% 
    dplyr::left_join(., hospitalizations, by = 'id_hospitalization') %>% 
    dplyr::left_join(., districts, by = 'id_district') %>% 
    dplyr::left_join(., regions, by = 'id_region') %>% 
    dplyr::mutate(report_date_case = as.Date(format(report_date_case, "%Y-%m-%d")),
                  admission_date_hospitalization = as.Date(format(admission_date_hospitalization, "%Y-%m-%d")),
                  onset_date_symptoms = as.Date(format(onset_date_symptoms, "%Y-%m-%d"))) %>% 
    dplyr::mutate(birthdate_person = as.Date(paste(birthdate_yyyy_person, birthdate_mm_person, birthdate_dd_person, sep = "-"), "%Y-%m-%d")) %>% 
    dplyr::select(-birthdate_yyyy_person, -birthdate_mm_person, -birthdate_dd_person) %>% 
    dplyr::mutate(report_date_age = CalculateBirthdateAge(birthdate_person, report_date_case)) %>% 
    dplyr::mutate(admission_date_age = CalculateBirthdateAge(birthdate_person, admission_date_hospitalization)) %>%
    dplyr::mutate(onset_date_age = CalculateBirthdateAge(birthdate_person, onset_date_symptoms)) %>%
    dplyr::mutate(death_age =  CalculateBirthdateAge(birthdate_person, death_date_person))
  
  # Return the output table
  return(line_list_cases)
}




