# **sormas-stats-sitrep**

sormas-stats-sitrep generates and downloads an automated situation report of the epidemic data generated by SORMAS. The situation report is created based on custom templates and is downloaded as an editable .docx document. Concretely, the sitrep app is a shiny app with a button to launch the knitting of an R-markdown.

## Table of contents
1. [sitrep-app folder](#sitrep-app-folder)
2. [Installation of necessary software](#installation-of-necessary-software)
    - [Using sitrep-app from a database backup file](#using-sitrep-app-from-a-database-backup-file)
3. [Downloading the Repository](#downloading-the-repository)
4. [Running sitrep-app](#running-sitrep-app)
5. [Custom Templates](#custom-templates)
6. [Placeholders](#placeholders)
  - [Country level](#country-level)
  - [Regional level](#regional-level)
7. [Referencing](#referencing)
    - [Multiple literature references](#multiple-literature-references)
    - [References to section headings](#references-to-section-headings)
    - [References to figures](#references-to-figures)
    - [References to tables](#references-to-tables)


# **sitrep-app folder**

- app.R

- global.R

- launch_app.R

- loading_data.R

- loading_functions.R

- loading_packages.R

- SitRep.Rmd

- data

- utils

  ​	

# **Installation of necessary software**

Make sure [R and RStudio](https://www.rstudio.com/products/rstudio/download/#download) software is installed on your device.

To use the sitrep app you then need to:

- Install an instance of [SORMAS](https://github.com/hzi-braunschweig/SORMAS-Project)

**or**

- request a SORMAS database backup file from the SORMAS team



### Using sitrep-app from a database backup file

In case of requesting and receiving a database backup file you need to following additional steps:

1. Download and install [PostgreSQL](https://www.postgresql.org/). 

2. For the installation setup:

   - make sure to have the box for the pgAdmin 4 component checked
   - choose a password that you remember
   - Port number should be left as default 5432
   - Choose the default locale 

3. Open pgAdmin 4 and enter your password.

4. Open _Servers_, enter your password again.

5. Create a new database by right clicking on _Databases(1)_ -> _Create_ 

   - Choose a name for the new database, e.g. "sormas_db", leave all other settings as default.

6. Restore your newly created database with the backup database file you received from the SORMAS team.

   - Right click on the new database -> _Restore..._ 
   - Choose the file path to the backup database file, leave all other options as default and click _Restore_.
   -  If you get the following **Error**: _Utility file not found: Utility file not found. Please correct the Binary Path in the Preferences Dialog._	Proceed as described below:
     - Go to _File_ -> _Preferences_ -> _Paths_ -> _Binary Paths_ 
     - Set the latest Postgres Database Server as default
     - Enter the directory in which the psql, pg_dump, pg_dumpall, and pg_restore utilities can be found, e.g.  _C:\Program Files\PostgreSQL\14\bin_
     - Save
     - Restore your newly created database with the backup SORMAS database file

7. Ignore any error messages about restoring backup on the server.

   

# Downloading the Repository

Download this repository into a directory of your choosing. 



# Running sitrep-app

**When running a SORMAS instance:**

To run the sitrep-app go to SORMAS-Stats-next-gen\sormas-stats-sitrep\sitrep-app directory in the repository on your machine and open the sitrep-app.Rproj.

Set the configuration to connect to the SORMAS instance in the `global.R` file:

- `DB_USER = "sormas_user"`
- `DB_PASS = "password"`
- `DB_HOST = "127.0.0.1"`
- `DB_PORT = "5432"`
- `DB_NAME = "sormas"`

Open the file `launch_app.R` and run it. 



**When using a SORMAS backup database file:**

To run the sitrep-app go to SORMAS-Stats-next-gen\sormas-stats-sitrep\sitrep-app directory in the repository on your machine and open the sitrep-app.Rproj.

Set the configuration for the postgres user account in the `global.R` file:

- `DB_USER = "postgres"` 
- `DB_PASS = "your_password"`
- `DB_HOST = "127.0.0.1"`
- `DB_PORT = "5432"`
- `DB_NAME = "your_database_name"`

Open the file `launch_app.R` and run it. 



# Custom Templates

The dynamic text in the situation reports is generated based on custom template word documents. These word documents are found in the sitrep-app/data/text directory. The names of the files indicate the corresponding part of the situation report. 

In these template files, the text which should appear in the situation report can be entered. Within this text markdown syntax can be used for references to literature, section headings, figures and tables. This is explained more in detail in the section [Referencing](#Referencing).

Moreover, placeholders for certain epidemic indicators (total cases, new cases etc.) can be inserted in the templates. The placeholders will be updated to display the numeric value of the indicators in the report. This is explained more in detail in the section [Placeholders](#Placeholders).



# Placeholders

The following epidemic indicators can be encoded in the situation report using placeholders:

- Total cases
- New cases
- Total hospitalizations
- New hospitalizations
- Total deaths
- New deaths

All of these indicators are available as the total number within the country or on regional level.

#### Country level 

To signify an epidemic indicator on country level with a placeholder in a template file, the following syntax needs to be used: `#Country_EpidemicIndicator`

- all placeholders start with #Country

- the epidemic indicator is specified at the end of the placeholder

- separated by an underscore

- Example to replace Total cases on country level:

  `#Country_TotalCases`

#### Regional level

To signify an epidemic indicator in a certain region with a placeholder in  a template file, the following syntax needs to be used: `#Region_EpidemicIndicator_Region`

- all placeholders start with #Region

- the epidemic indicator is specified in the middle of the placeholder

- the region name is added at the end

  - hyphens or spaces in the region name need to be removed

- separated by underscores

- Example to replace new hospitalizations in the region Kano:

  `#Region_NewHospitalizations_Kano`

- Example to replace total cases in the region Akwa-Ibom:

  `#Region_TotalCases_AkwaIbom`

- Example to replace total deaths in the region Voreingestelle Bundesländer:

  `Region_TotalDeaths_VoreingestelleBundesländer`

# Referencing

References to papers can be included via the references.bib and the .docx files in the data/text folder. First, the user needs to copy the BibTex reference of the paper he or she wants to cite in the references.bib file. Then, to define the place of the refence within the text, the user simply needs to put '[@refname]' in the text of the .docx template file where the citation should be. 

### Multiple literature references

To cite multiple references at once the following syntax has to be used `[@refname1;@refname2]`. refname is the BibTex reference name of the paper to be cited.

### References to section headings

For crossreferences to section headings the user needs to type `Section \@ref(label)` in the text witin the .docx file in the /text folder. 'label' is the Section ID of the section to be cited, which is defined through Pandoc as e.g. 'heading-one' for a Section named '# Heading one'.

The user can define section IDs by adding `{#userdefinedID}` behind a heading, e.g. `# Heading {#userdefinedID}`.

### References to figures

For crossreferences to figures the user needs to type `Figure \@ref(fig:FigName)` in the text witin the .docx file in the /text folder. FigName is the name of the figure to be cited, which is defined in the chunk options of the SitRep.Rmd file.

### References to tables

For crossreferences to tables the user needs to type `Table \@ref(tab:TabName)` in the text witin the .docx  template file in the data/text folder. TabName is the name of the table to be cited, which is defined in the chunk options of the SitRep.Rmd file.
